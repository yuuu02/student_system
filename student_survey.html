<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>學生學習表現調查表</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background-color: #f5f5f7;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #4877c4;
            color: #fff;
            padding: 16px 24px;
        }
        header h1 {
            margin: 0;
            font-size: 20px;
        }
        main {
            max-width: 900px;
            margin: 24px auto;
            padding: 0 16px 32px;
        }
        .card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            padding: 20px;
            margin-bottom: 24px;
        }
        .card h2 {
            margin-top: 0;
            font-size: 18px;
            border-left: 4px solid #4877c4;
            padding-left: 8px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 12px 24px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-size: 14px;
            margin-bottom: 4px;
        }
        .form-group span.hint {
            font-size: 12px;
            color: #777;
        }
        select {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        .actions {
            margin-top: 16px;
        }
        .btn {
            display: inline-block;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #4877c4;
            color: #fff;
        }
        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }
        .link-admin {
            margin-top: 12px;
            font-size: 14px;
        }
        .link-admin a {
            color: #4877c4;
            text-decoration: none;
        }
    </style>
</head>
<body>
<header>
    <h1>學生學習表現調查表</h1>
</header>

<main>
    <section class="card">
        <h2>請學生填寫以下資訊</h2>
        <p style="font-size:14px; color:#555;">
            選項已附上簡單中文說明。為了分析方便，<b>請至少選擇 IAP 等級</b>。<br>
            後台會根據 12 個特徵，自動推一個 <b>esp</b> 成績等級。
        </p>
        <form id="surveyForm">
            <div class="form-grid">

                <div class="form-group">
                    <label for="tnp">TNP – 十年級成績等級</label>
                    <select id="tnp">
                        <option value="">請選擇</option>
                        <option value="Best">Best（最佳）</option>
                        <option value="Very Good">Very Good（很好）</option>
                        <option value="Good">Good（普通）</option>
                        <option value="Pass">Pass（及格）</option>
                        <option value="Fail">Fail（不及格）</option>
                    </select>
                    <span class="hint">≥80 Best、60–79 Very Good、45–59 Good、30–44 Pass、&lt;30 Fail</span>
                </div>

                <div class="form-group">
                    <label for="twp">TWP – 十二年級成績等級</label>
                    <select id="twp">
                        <option value="">請選擇</option>
                        <option value="Best">Best（最佳）</option>
                        <option value="Very Good">Very Good（很好）</option>
                        <option value="Good">Good（普通）</option>
                        <option value="Pass">Pass（及格）</option>
                        <option value="Fail">Fail（不及格）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="iap">IAP – 內部評量成績等級 <span style="color:#d32f2f;">＊必填</span></label>
                    <select id="iap" required>
                        <option value="">請選擇</option>
                        <option value="Best">Best（最佳）</option>
                        <option value="Very Good">Very Good（很好）</option>
                        <option value="Good">Good（普通）</option>
                        <option value="Pass">Pass（及格）</option>
                        <option value="Fail">Fail（不及格）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="arr">ARR – 是否有重修科目</label>
                    <select id="arr">
                        <option value="">請選擇</option>
                        <option value="Y">Yes（有）</option>
                        <option value="N">No（沒有）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="asCat">AS – 入學類型</label>
                    <select id="asCat">
                        <option value="">請選擇</option>
                        <option value="Free">Free（公費／免費）</option>
                        <option value="Paid">Paid（自費）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sh">SH – 讀書時間（每天）</label>
                    <select id="sh">
                        <option value="">請選擇</option>
                        <option value="Good">Good（≥ 6 小時）</option>
                        <option value="Average">Average（4–5 小時）</option>
                        <option value="Poor">Poor（&lt; 2 小時）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="me">ME – 授課語言</label>
                    <select id="me">
                        <option value="">請選擇</option>
                        <option value="Eng">English（英文）</option>
                        <option value="Asm">Assamese（阿薩姆語）</option>
                        <option value="Hin">Hindi（印地語）</option>
                        <option value="Ben">Bengali（孟加拉語）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fs">FS – 家庭人數</label>
                    <select id="fs">
                        <option value="">請選擇</option>
                        <option value="Large">Large（大家庭 &gt; 12 人）</option>
                        <option value="Average">Average（一般 6–12 人）</option>
                        <option value="Small">Small（小家庭 &lt; 6 人）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="nf">NF – 朋友數量</label>
                    <select id="nf">
                        <option value="">請選擇</option>
                        <option value="Large">Large（很多）</option>
                        <option value="Average">Average（普通）</option>
                        <option value="Small">Small（較少）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="atd">ATD – 出席率</label>
                    <select id="atd">
                        <option value="">請選擇</option>
                        <option value="Good">Good（≥ 80%）</option>
                        <option value="Average">Average（60–79%）</option>
                        <option value="Poor">Poor（&lt; 60%）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fo">FO – 父親職業</label>
                    <select id="fo">
                        <option value="">請選擇</option>
                        <option value="Service">Service（受薪／上班族）</option>
                        <option value="Business">Business（生意）</option>
                        <option value="Retired">Retired（退休）</option>
                        <option value="Farmer">Farmer（農業）</option>
                        <option value="Others">Others（其他）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fmi">FMI – 家庭月收入</label>
                    <select id="fmi">
                        <option value="">請選擇</option>
                        <option value="Very High">Very High（非常高）</option>
                        <option value="High">High（高）</option>
                        <option value="Above Medium">Above Medium（中上）</option>
                        <option value="Medium">Medium（中等）</option>
                        <option value="Low">Low（低）</option>
                    </select>
                </div>

            </div>

            <div class="actions">
                <button type="submit" class="btn btn-primary">送出資料</button>
                <button type="reset" class="btn btn-secondary">清除表單</button>
            </div>
        </form>

        <div class="link-admin">
            管理者可前往：
            <a href="student_admin.html">學生學習表現管理後台</a>
        </div>
    </section>
</main>

<script>
(function () {
    "use strict";

    const STORAGE_KEY = "studentSurveyData";

    function loadData() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        try {
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
            console.error("loadData parse error:", e);
            return [];
        }
    }

    function saveData(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // ⭐ 新版 esp：IAP / SH / ATD 為主，TNP / TWP 為輔，其它小影響
    function calcEsp(rec) {
        // 共用：成績等級 0~4
        const gradeMajor = {
            "Best":      4,
            "Very Good": 3,
            "Good":      2,
            "Pass":      1,
            "Fail":      0
        };
    
        // ────────────── 1. 主力：IAP + SH + ATD ──────────────
        // IAP 用成績映射，SH / ATD 自訂 0~4
        const shMap = { "Good": 4, "Average": 2.5, "Poor": 0 };
        const atdMap = { "Good": 4, "Average": 2.5, "Poor": 0 };
    
        const majorScores = [];
    
        if (rec.iap && gradeMajor[rec.iap] != null) majorScores.push(gradeMajor[rec.iap]);
        if (rec.sh  && shMap[rec.sh]          != null) majorScores.push(shMap[rec.sh]);
        if (rec.atd && atdMap[rec.atd]        != null) majorScores.push(atdMap[rec.atd]);
    
        let majorAvg = majorScores.length
            ? majorScores.reduce((a, b) => a + b, 0) / majorScores.length
            : 2; // 都沒填，給一個中間值
    
        // ────────────── 2. 次要：TNP + TWP ──────────────
        const secondaryScores = [];
        if (rec.tnp && gradeMajor[rec.tnp] != null) secondaryScores.push(gradeMajor[rec.tnp]);
        if (rec.twp && gradeMajor[rec.twp] != null) secondaryScores.push(gradeMajor[rec.twp]);
    
        let secondaryAvg = secondaryScores.length
            ? secondaryScores.reduce((a, b) => a + b, 0) / secondaryScores.length
            : 2;
    
        // ────────────── 3. 其他七個小影響特徵 ──────────────
        // 映射到 0~4，但權重會很小
        const otherMaps = {
            arr:   { "N": 4, "Y": 1 },                             // 沒重修較好
            asCat: { "Free": 3, "Paid": 2 },                       // 公費略好
            me:    { "Eng": 3, "Asm": 2, "Hin": 2, "Ben": 2 },     // 英文稍好
            fs:    { "Small": 3, "Average": 2, "Large": 1 },
            nf:    { "Average": 3, "Large": 2, "Small": 1 },
            fo:    { "Service": 3, "Business": 3, "Retired": 2, "Farmer": 2, "Others": 2 },
            fmi:   { "Very High": 4, "High": 3.5, "Above Medium": 3,
                     "Medium": 2.5, "Low": 1 }
        };
    
        const otherScores = [];
        for (const key in otherMaps) {
            const v = rec[key];
            const map = otherMaps[key];
            if (v && map && map[v] != null) {
                otherScores.push(map[v]);
            }
        }
    
        let otherAvg = otherScores.length
            ? otherScores.reduce((a, b) => a + b, 0) / otherScores.length  // 0~4
            : 2; // 沒填就給中間值
    
        // ────────────── 4. 加權合成總分 (0~4) ──────────────
        // 主力 60% + 次要 25% + 其他 15%
        const score = 0.6 * majorAvg + 0.25 * secondaryAvg + 0.15 * otherAvg;
    
        // ────────────── 5. 依總分決定等級 ──────────────
        if (score >= 3.3) return "Best";
        if (score >= 2.6) return "Very Good";
        if (score >= 1.9) return "Good";
        if (score >= 1.1) return "Pass";
        return "Fail";
    }


    let data = loadData();

    function getFormData() {
        const getValue = id => document.getElementById(id).value.trim();
        const rec = {
            id: "r_" + Date.now().toString(36) + "_" + Math.random().toString(16).slice(2),
            tnp: getValue("tnp"),
            twp: getValue("twp"),
            iap: getValue("iap"),
            arr: getValue("arr"),
            asCat: getValue("asCat"),
            sh: getValue("sh"),
            me: getValue("me"),
            fs: getValue("fs"),
            nf: getValue("nf"),
            atd: getValue("atd"),
            fo: getValue("fo"),
            fmi: getValue("fmi"),
            createdAt: new Date().toISOString()
        };
        rec.esp = calcEsp(rec);   // ✅ 改成 esp
        return rec;
    }

    function validateForm(d) {
        if (!d.iap) {
            alert("請至少選擇 IAP 等級。");
            return false;
        }
        return true;
    }

    document.getElementById("surveyForm").addEventListener("submit", function (evt) {
        evt.preventDefault();
        const formData = getFormData();
        if (!validateForm(formData)) return;

        data.push(formData);
        saveData(data);
        this.reset();
        alert("資料已儲存，感謝填寫！");
    });
})();
</script>

</body>
</html>

